<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Current Location Map</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Tailwind CSS CDN for professional styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Keep map height defined here, rest is handled by Tailwind */
        #map {
            height: 400px;
            width: 100%;
        }
    </style>
</head>
<!-- Use Tailwind classes for a centered, modern look -->
<body class="bg-gray-100 font-sans antialiased">
    <!-- Main content container, centered on the screen -->
    <div class="flex flex-col items-center justify-center min-h-screen p-4">
        <!-- Professional Card Container -->
        <div class="w-full max-w-2xl bg-white rounded-xl shadow-2xl p-6 md:p-8">
            <h1 class="text-4xl font-extrabold text-blue-700 mb-2 tracking-tight">
                üåé Collaborative Location Tracker
            </h1>
            <p class="text-gray-500 text-sm md:text-base mb-4">
                Your user ID: <span id="userIdDisplay" class="font-mono text-xs bg-gray-200 p-1 rounded">loading...</span>
            </p>

            <!-- Location Button & Message -->
            <div class="flex justify-center mb-4">
                <button id="findLocationButton" class="flex items-center space-x-2 px-6 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 transition duration-150 transform hover:scale-[1.02] active:scale-[0.98]">
                    <!-- Location Pin Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                    </svg>
                    <span>Update My Location</span>
                </button>
            </div>
            
            <div id="message" class="bg-blue-50 border-l-4 border-blue-500 text-blue-700 p-4 mb-6 text-left font-semibold rounded-lg">
                Attempting to find location...
            </div>

            <!-- Map Container -->
            <div id="map" class="rounded-lg shadow-xl mb-6"></div>
            
            <!-- Other Users Location Display (New Feature) -->
            <h2 class="text-xl font-semibold text-gray-700 mb-3 border-b pb-1">
                üë• Real-Time Shared Locations
            </h2>
            <ul id="otherLocationsList" class="space-y-2 max-h-40 overflow-y-auto p-2 bg-gray-50 rounded-lg">
                <li class="text-gray-500">Waiting for other users' shared locations...</li>
            </ul>

        </div>
    </div>

    <!-- Leaflet JS must be loaded before our custom script -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- Firebase and Application Logic Script -->
    <script type="module">
        // Global variables provided by the environment (MANDATORY USE)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = 'loading...'; // Default state

        // Firebase Imports (MUST use module imports)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Helper for location saving path (Public collection for sharing)
        const PUBLIC_LOCATIONS_PATH = `artifacts/${appId}/public/data/locations`;

        // Map and UI elements
        const mapContainer = document.getElementById('map');
        const message = document.getElementById('message');
        const findButton = document.getElementById('findLocationButton');
        let map; // Variable to hold the Leaflet map object
        let userMarkers = {}; // To manage other users' markers

        // --- CORE FUNCTIONS ---

        async function setupFirebase() {
            try {
                if (!firebaseConfig) {
                    console.error("Firebase config is missing.");
                    return;
                }
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Authentication flow: Sign in with token or anonymously
                await new Promise(resolve => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                        } else if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            // Fallback to anonymous sign-in if no token is available
                            await signInAnonymously(auth);
                        }
                        
                        // Update UI with authenticated/anonymous ID
                        userId = auth.currentUser.uid;
                        document.getElementById('userIdDisplay').textContent = userId;
                        unsubscribe();
                        resolve();
                    });
                });
                
                // After setup and auth, only call initial location find.
                findLocation(); 
                
            } catch (error) {
                console.error("Firebase setup failed:", error);
                // Display a critical error message
                message.className = "bg-red-500 text-white p-4 mb-6 text-left font-bold rounded-lg";
                message.textContent = "CRITICAL ERROR: Failed to initialize database for collaborative features.";
            }
        }

        // Function to initiate the geolocation request
        function findLocation() {
            // Reset message to loading state
            message.className = "bg-blue-50 border-l-4 border-blue-500 text-blue-700 p-4 mb-6 text-left font-semibold rounded-lg";
            message.textContent = "Attempting to find location...";
            
             // 1. Check if Geolocation is supported
            if (!navigator.geolocation) {
                message.textContent = "Geolocation is not supported by your browser.";
                // Error style for unsupported browser
                message.className = "bg-yellow-50 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6 text-left font-semibold rounded-lg";
                mapContainer.style.display = 'none'; // Hide the map if not supported
            } else {
                // 2. Request the current position with high accuracy
                navigator.geolocation.getCurrentPosition(success, error, {
                    enableHighAccuracy: true,
                    timeout: 7000,
                    maximumAge: 0
                });
            }
        }
        
        // 3. Success callback: location found
        function success(position) {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;
            const accuracy = position.coords.accuracy;

            // Update message box to professional success look (Green)
            message.className = "bg-green-50 border-l-4 border-green-500 text-green-700 p-4 mb-6 text-left font-semibold rounded-lg";

            message.innerHTML = `
                Location Updated! <span class="font-black text-xl">‚úÖ</span>
                <br>
                <div class="mt-2 text-sm space-y-1">
                    <p><strong>Latitude:</strong> ${latitude.toFixed(5)}¬∞</p>
                    <p><strong>Longitude:</strong> ${longitude.toFixed(5)}¬∞</p>
                    <p><strong>Accuracy:</strong> ${accuracy.toFixed(2)} meters</p>
                </div>
            `;

            // 4. Initialize and display the map
            let mapInitialized = false; 
            if (!map) {
                // Map creation
                map = L.map('map').setView([latitude, longitude], 15);
            
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);
                mapInitialized = true;
            } else {
                // Map already exists, just update view
                map.setView([latitude, longitude], 15);
            }
            
            // CRITICAL FIX: Force Leaflet to re-evaluate the size of the container,
            // which resolves issues where the map is blank/greyed out in a card layout.
            if(map) {
                map.invalidateSize(); 
            }
            
            // 5. Add a marker for the current position and accuracy circle
            map.eachLayer(layer => {
                // Remove existing user's marker/circle to prevent duplicates
                if (layer instanceof L.Marker && layer.options.title === 'self') {
                    map.removeLayer(layer);
                }
                if (layer instanceof L.Circle && layer.options.title === 'self-accuracy') {
                    map.removeLayer(layer);
                }
            });

            const marker = L.marker([latitude, longitude], { title: 'self' })
                .addTo(map)
                .bindPopup("Your Current Location")
                .openPopup();
            
            const circle = L.circle([latitude, longitude], {
                color: '#10B981', // Tailwind green-500
                fillColor: '#34D399', // Tailwind green-400
                fillOpacity: 0.2,
                radius: accuracy,
                title: 'self-accuracy' 
            }).addTo(map);

            map.fitBounds(circle.getBounds(), { padding: [10, 10] });
            
            // 7. Save location to Firestore (Real-Time Location Sharing)
            if (db && userId && userId !== 'loading...') { // Ensure userId is captured
                const locationData = {
                    latitude: latitude,
                    longitude: longitude,
                    accuracy: accuracy,
                    timestamp: serverTimestamp(),
                    userId: userId,
                };
                // Store in public collection for sharing with other users/devices
                setDoc(doc(db, PUBLIC_LOCATIONS_PATH, userId), locationData)
                    .catch(e => console.error("Error writing document to Firestore:", e));
            }
            
            // 8. Start listener ONLY after map is confirmed initialized AND Firebase is ready
            // We use a property on the map object to track if the listener has been setup already
            if (mapInitialized || map && !map.listenerStarted) {
                startLocationListener();
                map.listenerStarted = true; 
            }
        }

        // 6. Error callback: location could not be found
        function error(err) {
            let errorMessage;
            switch (err.code) {
                case 1:
                    errorMessage = "üõë Permission Denied: You must allow location access to see the map. Click 'Update My Location' to try again.";
                    break;
                case 2:
                    errorMessage = "üõ∞Ô∏è Position Unavailable: Location information is currently unavailable.";
                    break;
                case 3:
                    errorMessage = "‚åõ Request Timeout: The request to get user location timed out.";
                    break;
                default:
                    errorMessage = `An unknown error occurred: (${err.code}).`;
            }
            
            // Update message box to professional error look (Red)
            message.className = "bg-red-50 border-l-4 border-red-500 text-red-700 p-4 mb-6 text-left font-semibold rounded-lg";
            message.textContent = errorMessage;
            
            if (!map) {
                mapContainer.innerHTML = '<p class="p-8 text-gray-500">Map area could not be initialized due to a location error.</p>';
                mapContainer.classList.remove('shadow-xl');
            }
        }
        
        // --- REAL-TIME SHARING (LISTENER) ---

        function startLocationListener() {
            // Added check to ensure map is initialized and database is ready
            if (!db || !map) return; 

            // Query for all locations EXCEPT the current user's location
            const q = query(collection(db, PUBLIC_LOCATIONS_PATH), where("userId", "!=", userId));
            const otherLocationsList = document.getElementById('otherLocationsList');

            onSnapshot(q, (snapshot) => {
                otherLocationsList.innerHTML = ''; // Clear the list
                let activeUsersFound = 0;
                
                snapshot.docs.forEach((doc) => {
                    const data = doc.data();
                    const otherUserId = data.userId;
                    const latLng = L.latLng(data.latitude, data.longitude);

                    // Skip the current user (should be handled by the query, but good for safety)
                    if (otherUserId === userId) return;
                    
                    activeUsersFound++;

                    // Update UI List
                    const listItem = document.createElement('li');
                    listItem.className = "p-2 bg-gray-50 border-l-2 border-purple-400 rounded-md shadow-sm";
                    
                    // The timestamp from Firestore is a Firebase Timestamp object, use toDate()
                    const time = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleTimeString() : 'N/A';

                    listItem.innerHTML = `
                        <span class="font-bold text-purple-700">User ID: ${otherUserId.substring(0, 8)}...</span>
                        <span class="text-xs text-gray-500 block">Lat: ${data.latitude.toFixed(4)}, Lon: ${data.longitude.toFixed(4)} (as of ${time})</span>
                    `;
                    otherLocationsList.appendChild(listItem);
                    
                    // Update Map Marker
                    if (userMarkers[otherUserId]) {
                        // Update existing marker position
                        userMarkers[otherUserId].setLatLng(latLng);
                        userMarkers[otherUserId].getPopup().setContent(`Shared Location: ${otherUserId.substring(0, 8)}...`);
                    } else {
                        // Create new marker with a custom icon
                        const iconHtml = '<div class="bg-purple-600 text-white font-semibold text-xs rounded-full p-2 w-7 h-7 flex items-center justify-center shadow-lg ring-2 ring-purple-300">üë§</div>';
                        const customIcon = L.divIcon({
                            className: 'custom-user-icon',
                            html: iconHtml,
                            iconSize: [28, 28],
                            iconAnchor: [14, 28] // Anchor point at bottom center
                        });

                        userMarkers[otherUserId] = L.marker(latLng, { icon: customIcon })
                            .addTo(map)
                            .bindPopup(`Shared Location: ${otherUserId.substring(0, 8)}...`);
                    }
                });
                
                // Cleanup: Remove markers for users who are no longer sharing
                // Iterate over all currently managed markers
                Object.keys(userMarkers).forEach(id => {
                    // Check if this user ID still exists in the snapshot (i.e., is still sharing)
                    const isStillSharing = snapshot.docs.some(doc => doc.id === id);
                    
                    if (!isStillSharing) {
                        map.removeLayer(userMarkers[id]);
                        delete userMarkers[id];
                    }
                });

                if (activeUsersFound === 0) {
                    otherLocationsList.innerHTML = '<li class="text-gray-500 italic">No other users are currently sharing their location.</li>';
                }
            });
        }

        // Event Listeners
        findButton.addEventListener('click', findLocation);
        
        // Start Firebase setup when the window loads
        window.onload = setupFirebase;
        
    </script>
</body>
</html>
